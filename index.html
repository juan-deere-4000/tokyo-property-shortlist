<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tokyo Property Shortlist</title>
  <style>
    :root {
      --primary: #0066cc;
      --primary-dark: #004c99;
      --success: #2a9d8f;
      --warning: #f4a261;
      --muted: #6c757d;
      --bg: #f8f9fa;
      --card-bg: #ffffff;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 24px;
      background: var(--bg);
      color: #333;
      line-height: 1.5;
    }

    h1 {
      color: #222;
      font-size: 28px;
      margin-bottom: 8px;
    }

    .subtitle {
      color: var(--muted);
      margin-bottom: 24px;
    }


    .property {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .property:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(0,0,0,0.12);
    }

    .property-header {
      display: grid;
      grid-template-columns: 48px 1fr auto;
      align-items: end;
      column-gap: 12px;
      margin-bottom: 12px;
    }

    .rank {
      font-size: 20px;
      font-weight: 700;
      color: var(--muted);
      text-align: right;
      flex-shrink: 0;
    }

    .property h2 {
      margin: 0;
      font-size: 18px;
      min-width: 0;
    }

    .property h2 a {
      text-decoration: none;
      color: var(--primary);
    }

    .property h2 a:hover {
      color: var(--primary-dark);
      text-decoration: underline;
    }

    .price {
      font-size: 22px;
      font-weight: 700;
      color: var(--success);
      white-space: nowrap;
    }
    .price-wrap {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      justify-self: end;
    }
    .aggregate-score {
      color: var(--primary);
      font-size: 20px;
      font-weight: 700;
      min-width: 38px;
      text-align: right;
    }
    .star-toggle {
      border: 1px solid #d8dee8;
      background: #fff;
      color: #a0acbb;
      border-radius: 6px;
      width: 28px;
      height: 28px;
      line-height: 1;
      font-size: 16px;
      cursor: pointer;
      padding: 0;
    }
    .star-toggle.active {
      color: #d99a00;
      border-color: #e6c96d;
      background: #fff8dc;
    }

    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 14px;
      margin: 0 0 18px 0;
      color: #4a5568;
      font-size: 14px;
      align-items: center;
    }
    .filters label {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      user-select: none;
    }

    .station-card {
      background: linear-gradient(135deg, #e8f4fd 0%, #f0f7ff 100%);
      border: 1px solid #d0e8f8;
      border-radius: 8px;
      padding: 12px 16px;
      margin: 12px 0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 8px;
    }

    .station-main {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .station-icon {
      font-size: 20px;
    }

    .station-name {
      font-weight: 600;
      font-size: 16px;
    }

    .station-name a {
      color: var(--primary);
      text-decoration: none;
    }

    .station-name a:hover {
      text-decoration: underline;
    }

    .station-line {
      color: var(--muted);
      font-size: 13px;
      margin-left: 8px;
    }

    .walk-badge, .transit-badge, .total-badge, .transit-pills {
      color: var(--primary);
      font-size: 13px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 2px;
    }

    .transit-pills {
      /* background: #f0f7ff; */
      padding: 4px 10px;
      border-radius: 16px;
    }

    .station-badges {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .meta {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 12px;
    }

    .tag {
      background: #f0f0f0;
      color: #444;
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 13px;
    }
    .tag.notes-toggle {
      border: 1px solid #d6deea;
      cursor: pointer;
      font-size: 13px;
      display: inline-flex;
      align-items: center;
      background: #f8fbff;
      color: #2f4058;
      box-shadow: 0 1px 1px rgba(0, 0, 0, 0.03);
    }
    .tag.notes-toggle[data-expanded="true"] {
      background: #eef5ff;
      color: #1f3555;
      border-color: #c6d4ea;
    }
    .tag.ratings-toggle {
      border: 1px solid #d6deea;
      cursor: pointer;
      font-size: 13px;
      display: inline-flex;
      align-items: center;
      background: #f8fbff;
      color: #2f4058;
      box-shadow: 0 1px 1px rgba(0, 0, 0, 0.03);
    }
    .tag.ratings-toggle[data-expanded="true"] {
      background: #eef5ff;
      color: #1f3555;
      border-color: #c6d4ea;
    }
    .meta-actions {
      margin-left: auto;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .notes-panel {
      background: linear-gradient(135deg, #e8f4fd 0%, #f0f7ff 100%);
      border: 1px solid #d0e8f8;
      border-radius: 8px;
      padding: 12px 16px;
      margin: 12px 0;
    }
    .ratings-panel {
      background: linear-gradient(135deg, #eef6ff 0%, #f6faff 100%);
      border: 1px solid #d8e6f7;
      border-radius: 8px;
      padding: 12px 16px;
      margin: 12px 0;
    }
    .ratings-panel.collapsed {
      display: none;
    }
    .ratings-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    .ratings-table th,
    .ratings-table td {
      padding: 6px 4px;
      text-align: left;
      vertical-align: middle;
      border-bottom: 1px solid #e6eef9;
    }
    .ratings-table tr:last-child td {
      border-bottom: 0;
    }
    .ratings-table th {
      color: #42566f;
      font-weight: 600;
    }
    .rating-control {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .rating-range {
      width: 92px;
    }
    .rating-stars {
      color: #d99a00;
      font-size: 12px;
      min-width: 50px;
    }
    .rating-value {
      color: #516277;
      min-width: 28px;
      text-align: right;
    }
    .notes-panel.collapsed {
      display: none;
    }
    .notes-input {
      width: 100%;
      min-height: 90px;
      border: 1px solid #c8dff0;
      border-radius: 6px;
      padding: 10px;
      font-size: 14px;
      font-family: inherit;
      resize: vertical;
      box-sizing: border-box;
    }
    .tag.transit {
      background: #fff3cd;
      color: #856404;
    }

    .tag.ward {
      background: #e2e3e5;
      color: #383d41;
    }


    .footer {
      text-align: center;
      color: var(--muted);
      margin-top: 40px;
      font-size: 14px;
    }

    @media (max-width: 600px) {
      .station-card {
        flex-direction: column;
        align-items: flex-start;
      }
      .property-header {
        grid-template-columns: 40px 1fr;
        row-gap: 8px;
        align-items: end;
      }
      .price {
        grid-column: 2;
        justify-self: end;
      }
    }
  </style>
</head>
<body>
  <h1>ğŸ  Tokyo Property Shortlist</h1>
  <p class="subtitle">Last updated: February 18, 2026</p>
  <div class="filters">
    <label><input type="checkbox" id="filter-starred-only"> Starred only</label>
    <label><input type="checkbox" id="filter-hide-sold" checked> Hide sold</label>
  </div>
  

  <div class="property">
    <div class="property-header">
      <span class="rank">#1</span>
      <h2><a href="properties/yotsuya-high-corp.html">Yotsuya High Corp (å››è°·ãƒã‚¤ã‚³ãƒ¼ãƒ‘)</a></h2>
      <span class="price">Â¥29.98M</span>
    </div>
    <div class="station-card">
      <div class="station-main">
        <span class="station-icon">ğŸš‰</span>
        <span class="station-name">
          <a href="https://www.google.com/maps/search/Yotsuya+Sanchome+Station+Tokyo" target="_blank">Yotsuya Sanchome Station</a>
          <span class="station-line">Tokyo Metro Marunouchi</span>
        </span>
      </div>
      <div class="station-badges">
        <span class="transit-pills">ğŸš¶ 7 min â†’ ğŸš‡ 10 min â†’ 17 min</span>
      </div>
    </div>
    <div class="meta">
      <span class="tag">2DK</span>
      <span class="tag">41.68mÂ²</span>
      <span class="tag ward">Shinjuku-ku</span>
      <span class="tag date">Feb 17</span>
    </div>
  </div>

  <div class="property">
    <div class="property-header">
      <span class="rank">#2</span>
      <h2><a href="properties/nakamachi-corp.html">Nakamachi Corp (ä»²ç”ºã‚³ãƒ¼ãƒãƒ©ã‚¹)</a></h2>
      <span class="price">Â¥26.2M</span>
    </div>
    <div class="station-card">
      <div class="station-main">
        <span class="station-icon">ğŸš‰</span>
        <span class="station-name">
          <a href="https://www.google.com/maps/search/Monzen-Nakacho+Station+Tokyo" target="_blank">Monzen-Nakacho Station</a>
          <span class="station-line">Toei Oedo</span>
        </span>
      </div>
      <div class="station-badges">
        <span class="transit-pills">ğŸš¶ 7 min â†’ ğŸš‡ 11 min â†’ 18 min</span>
      </div>
    </div>
    <div class="meta">
      <span class="tag">1LDK</span>
      <span class="tag">47.21mÂ²</span>
      <span class="tag ward">Koto-ku</span>
      <span class="tag date">Feb 17</span>
      <span class="tag" style="background: #dc3545; color: white;">Sold</span>
    </div>
  </div>

  <div class="property">
    <div class="property-header">
      <span class="rank">#3</span>
      <h2><a href="properties/kasuga-town-home.html">Kasuga Town Home (æ˜¥æ—¥ã‚¿ã‚¦ãƒ³ãƒ›ãƒ¼ãƒ )</a></h2>
      <span class="price">Â¥24.8M</span>
    </div>
    <div class="station-card">
      <div class="station-main">
        <span class="station-icon">ğŸš‰</span>
        <span class="station-name">
          <a href="https://www.google.com/maps/search/Korakuen+Station+Tokyo" target="_blank">Korakuen Station</a>
          <span class="station-line">Tokyo Metro Marunouchi</span>
        </span>
      </div>
      <div class="station-badges">
        <span class="transit-pills">ğŸš¶ 8 min â†’ ğŸš‡ 11 min â†’ 19 min</span>
      </div>
    </div>
    <div class="meta">
      <span class="tag">1LDK</span>
      <span class="tag">50.51mÂ²</span>
      <span class="tag ward">Bunkyo-ku</span>
      <span class="tag date">Feb 17</span>
    </div>
  </div>

  <div class="property">
    <div class="property-header">
      <span class="rank">#4</span>
      <h2><a href="https://realestate.yahoo.co.jp/used/mansion/detail_corp/b0024085388/" target="_blank">Kikugawa Royal Corp (èŠå·ãƒ­ãƒ¼ã‚¶ãƒ«ã‚³ãƒ¼ãƒ)</a></h2>
      <span class="price">Â¥26.8M</span>
    </div>
    <div class="station-card">
      <div class="station-main">
        <span class="station-icon">ğŸš‰</span>
        <span class="station-name">
          <a href="https://www.google.com/maps/search/Kikkawa+Station+Tokyo" target="_blank">Kikkawa Station</a>
          <span class="station-line">Toei Shinjuku</span>
        </span>
      </div>
      <div class="station-badges">
        <span class="transit-pills">ğŸš¶ 4 min â†’ ğŸš‡ 15 min â†’ 19 min</span>
      </div>
    </div>
    <div class="meta">
      <span class="tag">1LDK</span>
      <span class="tag">40.16mÂ²</span>
      <span class="tag ward">Sumida-ku</span>
      <span class="tag date">Feb 18</span>
    </div>
  </div>

  <div class="property">
    <div class="property-header">
      <span class="rank">#5</span>
      <h2><a href="properties/heitsu-otowa.html">Heitsu Otowa (ãƒã‚¤ãƒ„éŸ³ç¾½)</a></h2>
      <span class="price">Â¥29.99M</span>
    </div>
    <div class="station-card">
      <div class="station-main">
        <span class="station-icon">ğŸš‰</span>
        <span class="station-name">
          <a href="https://www.google.com/maps/search/Gokokuji+Station+Tokyo" target="_blank">Gokokuji Station</a>
          <span class="station-line">Tokyo Metro Yurakucho</span>
        </span>
      </div>
      <div class="station-badges">
        <span class="transit-pills">ğŸš¶ 3 min â†’ ğŸš‡ 17 min â†’ 20 min</span>
      </div>
    </div>
    <div class="meta">
      <span class="tag">1LDK</span>
      <span class="tag">37.44mÂ²</span>
      <span class="tag ward">Bunkyo-ku</span>
      <span class="tag date">Feb 17</span>
    </div>
  </div>

  <div class="property">
    <div class="property-header">
      <span class="rank">#6</span>
      <h2><a href="properties/tabata-mansion.html">Tabata Mansion (ç”°ç«¯ãƒãƒ³ã‚·ãƒ§ãƒ³)</a></h2>
      <span class="price">Â¥29.8M</span>
    </div>
    <div class="station-card">
      <div class="station-main">
        <span class="station-icon">ğŸš‰</span>
        <span class="station-name">
          <a href="https://www.google.com/maps/search/Tabata+Station+Tokyo" target="_blank">Tabata Station</a>
          <span class="station-line">JR Yamanote Line</span>
        </span>
      </div>
      <div class="station-badges">
        <span class="transit-pills">ğŸš¶ 5 min â†’ ğŸš‡ 15 min â†’ 20 min</span>
      </div>
    </div>
    <div class="meta">
      <span class="tag">2LDK</span>
      <span class="tag">45.76mÂ²</span>
      <span class="tag ward">Kita-ku</span>
      <span class="tag date">Feb 17</span>
    </div>
  </div>

  <div class="property">
    <div class="property-header">
      <span class="rank">#7</span>
      <h2><a href="properties/oedo-corp.html">Oedo Corp (å¤§æ±Ÿæˆ¸ã‚³ãƒ¼ãƒ‘)</a></h2>
      <span class="price">Â¥29.8M</span>
    </div>
    <div class="station-card">
      <div class="station-main">
        <span class="station-icon">ğŸš‰</span>
        <span class="station-name">
          <a href="https://www.google.com/maps/search/Nakano-Sakaue+Station+Tokyo" target="_blank">Nakano-Sakaue Station</a>
          <span class="station-line">Tokyo Metro Marunouchi</span>
        </span>
      </div>
      <div class="station-badges">
        <span class="transit-pills">ğŸš¶ 1 min â†’ ğŸš‡ 20 min â†’ 21 min</span>
      </div>
    </div>
    <div class="meta">
      <span class="tag">1LDK</span>
      <span class="tag">46.28mÂ²</span>
      <span class="tag ward">Nakano-ku</span>
      <span class="tag date">Feb 17</span>
    </div>
  </div>

  <div class="property">
    <div class="property-header">
      <span class="rank">#8</span>
      <h2><a href="properties/hasegawa-heights.html">Hasegawa Heights (ãƒã‚»ã‚¬ãƒ¯ãƒã‚¤ãƒ„)</a></h2>
      <span class="price">Â¥27.8M</span>
    </div>
    <div class="station-card">
      <div class="station-main">
        <span class="station-icon">ğŸš‰</span>
        <span class="station-name">
          <a href="https://www.google.com/maps/search/Gokokuji+Station+Tokyo" target="_blank">Gokokuji Station</a>
          <span class="station-line">Tokyo Metro Yurakucho</span>
        </span>
      </div>
      <div class="station-badges">
        <span class="transit-pills">ğŸš¶ 4 min â†’ ğŸš‡ 17 min â†’ 21 min</span>
      </div>
    </div>
    <div class="meta">
      <span class="tag">1LDK</span>
      <span class="tag">47.04mÂ²</span>
      <span class="tag ward">Bunkyo-ku</span>
      <span class="tag date">Feb 17</span>
    </div>
  </div>

  <div class="property">
    <div class="property-header">
      <span class="rank">#9</span>
      <h2><a href="properties/palm-house-bunkyo.html">Palm House Bunkyo (ãƒ‘ãƒ«ãƒ ãƒã‚¦ã‚¹æ–‡äº¬)</a></h2>
      <span class="price">Â¥31.8M</span>
    </div>
    <div class="station-card">
      <div class="station-main">
        <span class="station-icon">ğŸš‰</span>
        <span class="station-name">
          <a href="https://www.google.com/maps/search/Edogawabashi+Station+Tokyo" target="_blank">Edogawabashi Station</a>
          <span class="station-line">Tokyo Metro Yurakucho</span>
        </span>
      </div>
      <div class="station-badges">
        <span class="transit-pills">ğŸš¶ 7 min â†’ ğŸš‡ 15 min â†’ 22 min</span>
      </div>
    </div>
    <div class="meta">
      <span class="tag">2DK</span>
      <span class="tag">47.43mÂ²</span>
      <span class="tag ward">Bunkyo-ku</span>
      <span class="tag date">Feb 17</span>
    </div>
  </div>

  <div class="property">
    <div class="property-header">
      <span class="rank">#10</span>
      <h2><a href="properties/palast-nippori.html">Palast Nippori (ãƒ‘ãƒ©ã‚¹ãƒˆæ—¥æš®é‡Œ)</a></h2>
      <span class="price">Â¥26.99M</span>
    </div>
    <div class="station-card">
      <div class="station-main">
        <span class="station-icon">ğŸš‰</span>
        <span class="station-name">
          <a href="https://www.google.com/maps/search/Nippori+Station+Tokyo" target="_blank">Nippori Station</a>
          <span class="station-line">JR Yamanote</span>
        </span>
      </div>
      <div class="station-badges">
        <span class="transit-pills">ğŸš¶ 14 min â†’ ğŸš‡ 12 min â†’ 26 min</span>
      </div>
    </div>
    <div class="meta">
      <span class="tag">1LDK</span>
      <span class="tag">44.7mÂ²</span>
      <span class="tag ward">Arakawa-ku</span>
      <span class="tag date">Feb 17</span>
    </div>
  </div>

  <div class="property">
    <div class="property-header">
      <span class="rank">#11</span>
      <h2><a href="properties/happy-heights-kameido.html">Happy Heights Kameido (ãƒãƒ”ãƒ¼ãƒã‚¤ãƒ„äº€æˆ¸)</a></h2>
      <span class="price">Â¥25.8M</span>
    </div>
    <div class="station-card">
      <div class="station-main">
        <span class="station-icon">ğŸš‰</span>
        <span class="station-name">
          <a href="https://www.google.com/maps/search/Kameido+Station+Tokyo" target="_blank">Kameido Station</a>
          <span class="station-line">JR Sobu</span>
        </span>
      </div>
      <div class="station-badges">
        <span class="transit-pills">ğŸš¶ 3 min â†’ ğŸš‡ 25 min â†’ 28 min</span>
      </div>
    </div>
    <div class="meta">
      <span class="tag">2LDK</span>
      <span class="tag">46.18mÂ²</span>
      <span class="tag ward">Koto-ku</span>
      <span class="tag date">Feb 18</span>
    </div>
  </div>

  <div class="property">
    <div class="property-header">
      <span class="rank">#12</span>
      <h2><a href="properties/ojima-royal-mansion.html">Ojima Royal Mansion (å¤§å³¶ãƒ­ã‚¤ãƒ¤ãƒ«ãƒãƒ³ã‚·ãƒ§ãƒ³)</a></h2>
      <span class="price">Â¥22.8M</span>
    </div>
    <div class="station-card">
      <div class="station-main">
        <span class="station-icon">ğŸš‰</span>
        <span class="station-name">
          <a href="https://www.google.com/maps/search/Ojima+Station+Tokyo" target="_blank">Ojima Station</a>
          <span class="station-line">Toei Shinjuku</span>
        </span>
      </div>
      <div class="station-badges">
        <span class="transit-pills">ğŸš¶ 7 min â†’ ğŸš‡ 24 min â†’ 31 min</span>
      </div>
    </div>
    <div class="meta">
      <span class="tag">1LDK</span>
      <span class="tag">40.01mÂ²</span>
      <span class="tag ward">Koto-ku</span>
      <span class="tag date">Feb 18</span>
    </div>
  </div>

  <div class="property">
    <div class="property-header">
      <span class="rank">#13</span>
      <h2><a href="properties/koken-heights-mejiro.html">Koken Heights Mejiro (å…‰å»ºãƒã‚¤ãƒ„ç›®ç™½)</a></h2>
      <span class="price">Â¥27.5M</span>
    </div>
    <div class="station-card">
      <div class="station-main">
        <span class="station-icon">ğŸš‰</span>
        <span class="station-name">
          <a href="https://www.google.com/maps/search/Shiinamachi+Station+Tokyo" target="_blank">Shiinamachi Station</a>
          <span class="station-line">Seibu Ikebukuro</span>
        </span>
      </div>
      <div class="station-badges">
        <span class="transit-pills">ğŸš¶ 7 min â†’ ğŸš‡ 27 min â†’ 34 min</span>
      </div>
    </div>
    <div class="meta">
      <span class="tag">2DK</span>
      <span class="tag">49.77mÂ²</span>
      <span class="tag ward">Toshima-ku</span>
      <span class="tag date">Feb 18</span>
    </div>
  </div>

  <div class="footer">
    <p>Built with â¤ï¸ by juan</p>
  </div>
  <script src="notes-config.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const NOTES_CONFIG = Object.assign(
      {
        supabaseUrl: '',
        supabaseAnonKey: '',
        table: 'property_notes',
        starTable: 'property_flags',
        ratingTable: 'property_ratings'
      },
      window.NOTES_CONFIG || {}
    );
    const STAR_STORAGE_KEY = 'tokyo_starred_properties_v1';
    const FILTER_STORAGE_KEY = 'tokyo_property_filters_v1';
    const RATING_STORAGE_KEY = 'tokyo_property_ratings_v1';
    const RATERS = ['Joe', 'Max', 'Michelle'];
    const METRICS = ['Neighborhood', 'Transit', 'Layout'];

    function getPropertySlug(card, idx) {
      const link = card.querySelector('.property-header h2 a');
      const href = link ? (link.getAttribute('href') || '') : '';
      const m = href.match(/properties\/([^/.]+)\.html/i);
      if (m) return m[1];
      const text = (link ? link.textContent : '').toLowerCase();
      if (text.includes('kikugawa')) return 'kikugawa-royal-corp';
      return 'property-' + idx;
    }

    function ensureMetaActions(meta) {
      let actions = meta.querySelector('.meta-actions');
      if (!actions) {
        actions = document.createElement('span');
        actions.className = 'meta-actions';
        meta.appendChild(actions);
      }
      return actions;
    }

    function formatPrices() {
      document.querySelectorAll('.price').forEach(function (el) {
        const m = (el.textContent || '').match(/Â¥\s*([0-9]+(?:\.[0-9]+)?)\s*M/i);
        if (!m) return;
        const value = Number(m[1]);
        if (!Number.isFinite(value)) return;
        el.textContent = 'Â¥' + value.toFixed(1) + 'M';
      });
    }

    function isSoldCard(card) {
      return Array.from(card.querySelectorAll('.meta .tag')).some(function (tag) {
        return (tag.textContent || '').trim().toLowerCase() === 'sold';
      });
    }

    function loadStarredSetLocal() {
      try {
        const raw = localStorage.getItem(STAR_STORAGE_KEY);
        const arr = raw ? JSON.parse(raw) : [];
        return new Set(Array.isArray(arr) ? arr : []);
      } catch (_) {
        return new Set();
      }
    }

    function saveStarredSetLocal(set) {
      localStorage.setItem(STAR_STORAGE_KEY, JSON.stringify(Array.from(set)));
    }

    function loadRatingsLocal() {
      try {
        const raw = localStorage.getItem(RATING_STORAGE_KEY);
        const obj = raw ? JSON.parse(raw) : {};
        return obj && typeof obj === 'object' ? obj : {};
      } catch (_) {
        return {};
      }
    }

    function saveRatingsLocal(store) {
      localStorage.setItem(RATING_STORAGE_KEY, JSON.stringify(store));
    }

    function ratingKey(slug, rater, metric) {
      return slug + '||' + rater + '||' + metric;
    }

    function starsFromScore(score) {
      if (score == null) return 'â˜†â˜†â˜†â˜†â˜†';
      const full = Math.floor(score / 2);
      const half = score % 2 >= 1 ? 1 : 0;
      const empty = 5 - full - half;
      return 'â˜…'.repeat(full) + (half ? 'Â½' : '') + 'â˜†'.repeat(Math.max(0, empty));
    }

    function updateAggregateForCard(card, slug, ratingsStore) {
      const wrap = card.querySelector('.price-wrap');
      if (!wrap) return;
      const badge = wrap.querySelector('.aggregate-score');
      if (!badge) return;
      const values = [];
      RATERS.forEach(function (rater) {
        METRICS.forEach(function (metric) {
          const v = ratingsStore[ratingKey(slug, rater, metric)];
          if (typeof v === 'number' && Number.isFinite(v)) values.push(v);
        });
      });
      if (!values.length) {
        badge.style.display = 'none';
        badge.textContent = '';
        return;
      }
      const avg = values.reduce(function (a, b) { return a + b; }, 0) / values.length;
      badge.style.display = '';
      badge.textContent = avg.toFixed(1);
    }

    function loadFilterState() {
      try {
        const raw = localStorage.getItem(FILTER_STORAGE_KEY);
        const v = raw ? JSON.parse(raw) : {};
        return {
          starredOnly: Boolean(v.starredOnly),
          hideSold: v.hideSold !== false
        };
      } catch (_) {
        return { starredOnly: false, hideSold: true };
      }
    }

    function saveFilterState(state) {
      localStorage.setItem(FILTER_STORAGE_KEY, JSON.stringify(state));
    }

    function applyFilters() {
      const starredOnlyEl = document.getElementById('filter-starred-only');
      const hideSoldEl = document.getElementById('filter-hide-sold');
      if (!starredOnlyEl || !hideSoldEl) return;
      const starredOnly = starredOnlyEl.checked;
      const hideSold = hideSoldEl.checked;
      document.querySelectorAll('.property').forEach(function (card) {
        const starred = card.getAttribute('data-starred') === 'true';
        const sold = card.getAttribute('data-sold') === 'true';
        const show = (!starredOnly || starred) && (!hideSold || !sold);
        card.style.display = show ? '' : 'none';
      });
      saveFilterState({ starredOnly: starredOnly, hideSold: hideSold });
    }

    async function initStarsAndFilters() {
      formatPrices();
      const hasSupabase = NOTES_CONFIG.supabaseUrl && NOTES_CONFIG.supabaseAnonKey && window.supabase;
      const supabaseClient = hasSupabase
        ? window.supabase.createClient(NOTES_CONFIG.supabaseUrl, NOTES_CONFIG.supabaseAnonKey)
        : null;
      const starredSet = loadStarredSetLocal();

      const cards = Array.from(document.querySelectorAll('.property'));
      const slugs = cards.map(function (card, idx) {
        return getPropertySlug(card, idx + 1);
      });

      if (hasSupabase) {
        try {
          const { data } = await supabaseClient
            .from(NOTES_CONFIG.starTable)
            .select('property_slug, starred')
            .in('property_slug', slugs);
          (data || []).forEach(function (row) {
            if (row.starred) starredSet.add(row.property_slug);
            else starredSet.delete(row.property_slug);
          });
          saveStarredSetLocal(starredSet);
        } catch (err) {
          console.error('Failed to load shared stars, using local fallback', err);
        }
      }

      cards.forEach(function (card, idx) {
        const slug = getPropertySlug(card, idx + 1);
        card.setAttribute('data-property-slug', slug);
        card.setAttribute('data-sold', isSoldCard(card) ? 'true' : 'false');

        const header = card.querySelector('.property-header');
        const price = card.querySelector('.price');
        if (!header || !price) return;

        let wrap = header.querySelector('.price-wrap');
        if (!wrap) {
          wrap = document.createElement('div');
          wrap.className = 'price-wrap';
          header.insertBefore(wrap, price);
          wrap.appendChild(price);
        }
        let aggregate = wrap.querySelector('.aggregate-score');
        if (!aggregate) {
          aggregate = document.createElement('span');
          aggregate.className = 'aggregate-score';
          aggregate.style.display = 'none';
          wrap.insertBefore(aggregate, price);
        }

        const star = document.createElement('button');
        star.type = 'button';
        star.className = 'star-toggle';
        star.setAttribute('aria-label', 'Toggle star');
        const active = starredSet.has(slug);
        star.classList.toggle('active', active);
        star.textContent = active ? 'â˜…' : 'â˜†';
        card.setAttribute('data-starred', active ? 'true' : 'false');

        star.addEventListener('click', function () {
          const isActive = star.classList.toggle('active');
          star.textContent = isActive ? 'â˜…' : 'â˜†';
          card.setAttribute('data-starred', isActive ? 'true' : 'false');
          if (isActive) starredSet.add(slug); else starredSet.delete(slug);
          saveStarredSetLocal(starredSet);

          if (hasSupabase) {
            (async function () {
              try {
                await supabaseClient
                  .from(NOTES_CONFIG.starTable)
                  .upsert(
                    { property_slug: slug, starred: isActive, updated_at: new Date().toISOString() },
                    { onConflict: 'property_slug' }
                  );
              } catch (err) {
                console.error('Shared star save failed for', slug, err);
              }
            })();
          }

          applyFilters();
        });

        wrap.appendChild(star);
      });

      const starredOnlyEl = document.getElementById('filter-starred-only');
      const hideSoldEl = document.getElementById('filter-hide-sold');
      const fs = loadFilterState();
      if (starredOnlyEl) starredOnlyEl.checked = fs.starredOnly;
      if (hideSoldEl) hideSoldEl.checked = fs.hideSold;
      if (starredOnlyEl) starredOnlyEl.addEventListener('change', applyFilters);
      if (hideSoldEl) hideSoldEl.addEventListener('change', applyFilters);

      applyFilters();
    }

    function createNotesUI(card, slug) {
      const meta = card.querySelector('.meta');
      if (!meta) return null;
      const actions = ensureMetaActions(meta);

      const toggle = document.createElement('button');
      toggle.type = 'button';
      toggle.className = 'tag notes-toggle';
      toggle.setAttribute('data-expanded', 'false');
      toggle.textContent = 'Notes';

      actions.appendChild(toggle);

      const panel = document.createElement('div');
      panel.className = 'notes-panel collapsed';
      panel.setAttribute('aria-hidden', 'true');
      panel.innerHTML =
        '<textarea class="notes-input" placeholder="Add shared notes for this property..."></textarea>';
      card.appendChild(panel);

      function setExpanded(expanded) {
        toggle.setAttribute('data-expanded', expanded ? 'true' : 'false');
        toggle.textContent = 'Notes';
        panel.classList.toggle('collapsed', !expanded);
        panel.setAttribute('aria-hidden', expanded ? 'false' : 'true');
      }

      toggle.addEventListener('click', function () {
        setExpanded(toggle.getAttribute('data-expanded') !== 'true');
      });

      return { slug, panel, toggle, setExpanded };
    }

    function createRatingsUI(card, slug) {
      const meta = card.querySelector('.meta');
      if (!meta) return null;
      const actions = ensureMetaActions(meta);

      const toggle = document.createElement('button');
      toggle.type = 'button';
      toggle.className = 'tag ratings-toggle';
      toggle.setAttribute('data-expanded', 'false');
      toggle.textContent = 'Ratings';

      const notesToggle = actions.querySelector('.notes-toggle');
      if (notesToggle) actions.insertBefore(toggle, notesToggle);
      else actions.appendChild(toggle);

      const panel = document.createElement('div');
      panel.className = 'ratings-panel collapsed';
      panel.setAttribute('aria-hidden', 'true');

      let html = '<table class="ratings-table"><thead><tr><th></th>';
      METRICS.forEach(function (metric) {
        html += '<th>' + metric + '</th>';
      });
      html += '</tr></thead><tbody>';
      RATERS.forEach(function (rater) {
        html += '<tr><th>' + rater + '</th>';
        METRICS.forEach(function (metric) {
          html += '<td><div class="rating-control" data-rater="' + rater + '" data-metric="' + metric + '">' +
            '<input class="rating-range" type="range" min="0" max="10" step="0.5" value="0">' +
            '<span class="rating-stars">â˜†â˜†â˜†â˜†â˜†</span>' +
            '<span class="rating-value">â€”</span>' +
            '</div></td>';
        });
        html += '</tr>';
      });
      html += '</tbody></table>';
      panel.innerHTML = html;
      card.appendChild(panel);

      function setExpanded(expanded) {
        toggle.setAttribute('data-expanded', expanded ? 'true' : 'false');
        panel.classList.toggle('collapsed', !expanded);
        panel.setAttribute('aria-hidden', expanded ? 'false' : 'true');
      }
      toggle.addEventListener('click', function () {
        setExpanded(toggle.getAttribute('data-expanded') !== 'true');
      });

      return { slug, panel, toggle, setExpanded, card };
    }

    async function initRatings() {
      const cards = Array.from(document.querySelectorAll('.property'));
      const hasSupabase = NOTES_CONFIG.supabaseUrl && NOTES_CONFIG.supabaseAnonKey && window.supabase;
      const supabaseClient = hasSupabase
        ? window.supabase.createClient(NOTES_CONFIG.supabaseUrl, NOTES_CONFIG.supabaseAnonKey)
        : null;
      const ratingsStore = loadRatingsLocal();
      const saveTimers = {};

      const entries = cards
        .map((card, idx) => createRatingsUI(card, getPropertySlug(card, idx + 1)))
        .filter(Boolean);
      const slugs = entries.map(function (e) { return e.slug; });

      if (hasSupabase) {
        try {
          const { data } = await supabaseClient
            .from(NOTES_CONFIG.ratingTable)
            .select('property_slug, rater, metric, score')
            .in('property_slug', slugs);
          (data || []).forEach(function (row) {
            const score = Number(row.score);
            if (!Number.isFinite(score)) return;
            ratingsStore[ratingKey(row.property_slug, row.rater, row.metric)] = score;
          });
          saveRatingsLocal(ratingsStore);
        } catch (err) {
          console.error('Failed to load shared ratings, using local fallback', err);
        }
      }

      function renderControl(control, score) {
        const stars = control.querySelector('.rating-stars');
        const value = control.querySelector('.rating-value');
        if (score == null || !Number.isFinite(score)) {
          stars.textContent = 'â˜†â˜†â˜†â˜†â˜†';
          value.textContent = 'â€”';
          return;
        }
        stars.textContent = starsFromScore(score);
        value.textContent = score.toFixed(1);
      }

      entries.forEach(function (entry) {
        const controls = Array.from(entry.panel.querySelectorAll('.rating-control'));
        controls.forEach(function (control) {
          const rater = control.getAttribute('data-rater');
          const metric = control.getAttribute('data-metric');
          const range = control.querySelector('.rating-range');
          const key = ratingKey(entry.slug, rater, metric);
          const existing = ratingsStore[key];
          if (typeof existing === 'number' && Number.isFinite(existing)) {
            range.value = String(existing);
            renderControl(control, existing);
          } else {
            renderControl(control, null);
          }

          const persist = function (score) {
            ratingsStore[key] = score;
            saveRatingsLocal(ratingsStore);
            if (hasSupabase) {
              (async function () {
                try {
                  const { error } = await supabaseClient
                    .from(NOTES_CONFIG.ratingTable)
                    .upsert(
                      {
                        property_slug: entry.slug,
                        rater: rater,
                        metric: metric,
                        score: score,
                        updated_at: new Date().toISOString()
                      },
                      { onConflict: 'property_slug,rater,metric' }
                    );
                  if (error) throw error;
                } catch (err) {
                  console.error('Shared rating save failed', entry.slug, rater, metric, err);
                }
              })();
            }
          };

          const onChange = function () {
            const score = Number(range.value);
            renderControl(control, score);
            updateAggregateForCard(entry.card, entry.slug, ratingsStore);
            if (saveTimers[key]) clearTimeout(saveTimers[key]);
            saveTimers[key] = setTimeout(function () {
              persist(score);
            }, 400);
          };

          range.addEventListener('input', onChange);
          range.addEventListener('change', onChange);
        });

        updateAggregateForCard(entry.card, entry.slug, ratingsStore);
      });
    }

    async function initNotes() {
      const cards = Array.from(document.querySelectorAll('.property'));
      const entries = cards.map((card, idx) => createNotesUI(card, getPropertySlug(card, idx + 1))).filter(Boolean);
      const slugs = entries.map(e => e.slug);

      const hasSupabase = NOTES_CONFIG.supabaseUrl && NOTES_CONFIG.supabaseAnonKey && window.supabase;
      const localStore = {};

      if (!hasSupabase) {
        entries.forEach(e => {
          const v = localStorage.getItem('tokyo_notes_' + e.slug);
          if (v) localStore[e.slug] = v;
        });
      }

      let supabaseClient = null;
      let remoteStore = {};

      if (hasSupabase) {
        supabaseClient = window.supabase.createClient(NOTES_CONFIG.supabaseUrl, NOTES_CONFIG.supabaseAnonKey);
        const { data } = await supabaseClient
          .from(NOTES_CONFIG.table)
          .select('property_slug, body')
          .in('property_slug', slugs);
        (data || []).forEach(function (row) {
          remoteStore[row.property_slug] = row.body || '';
        });
      }

      entries.forEach(function (entry) {
        const input = entry.panel.querySelector('.notes-input');
        const existing = hasSupabase ? (remoteStore[entry.slug] || '') : (localStore[entry.slug] || '');
        let saveTimer = null;

        if (existing.trim()) {
          input.value = existing;
          entry.setExpanded(true);
        }

        async function persistNote(value) {
          try {
            if (hasSupabase) {
              if (value) {
                const { error } = await supabaseClient
                  .from(NOTES_CONFIG.table)
                  .upsert(
                    { property_slug: entry.slug, body: value, updated_at: new Date().toISOString() },
                    { onConflict: 'property_slug' }
                  );
                if (error) throw error;
              } else {
                const { error } = await supabaseClient
                  .from(NOTES_CONFIG.table)
                  .delete()
                  .eq('property_slug', entry.slug);
                if (error) throw error;
              }
            } else {
              localStorage.setItem('tokyo_notes_' + entry.slug, value);
            }
          } catch (err) {
            console.error('Notes autosave failed for', entry.slug, err);
          }
        }

        input.addEventListener('input', function () {
          const value = input.value.trim();
          if (value) entry.setExpanded(true);
          if (saveTimer) clearTimeout(saveTimer);
          saveTimer = setTimeout(function () {
            persistNote(value);
          }, 500);
        });
      });
    }

    (async function () {
      await initStarsAndFilters();
      await initRatings();
      initNotes();
    })();
  </script>
</body>
</html>
<!-- Wed Feb 18 16:28:00 +07 2026 -->
