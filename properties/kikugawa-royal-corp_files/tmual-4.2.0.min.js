!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).tmual=e()}(this,function(){"use strict";function t(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var e,i={exports:{}};var n=(e||(e=1,function(t,e){!function(t){function e(t){return Object.prototype.toString.call(t).slice(8,-1)}function i(t,i){return null!=i&&e(i)===t}function n(t){return i("Object",t)}function r(t){return i("Array",t)}function s(t){return i("String",t)}function o(t){return"number"==typeof t&&Math.abs(t)===1/0}function a(t){return i("Number",t)&&!Number.isNaN(t)&&!o(t)}function l(t){return null===t}function u(t){return void 0===t}function c(t){const e=t.split("#")[0].split("?");return 1===e.length?null:e.slice(1).join("?")}var d,h,g,p={getType:e,is:i,isObject:n,isArray:r,isString:s,isNumber:a,isBoolean:function(t){return i("Boolean",t)},isFunction:function(t){return i("Function",t)},isNull:l,isUndefined:u,findKey:function(t,e){return i("Object",t)&&Object.prototype.hasOwnProperty.call(t,e)},isUUID:function(t){return/^[\da-fA-F]{8}-[\da-fA-F]{4}-[\da-fA-F]{4}-[\da-fA-F]{4}-[\da-fA-F]{12}$/.test(t)},deepCopy:function(t){return JSON.parse(JSON.stringify(t))},merge:function(...t){return Object.assign({},...t)},getTime:function(){return(new Date).getTime()},normalizeToString:function(t){return`${t}`},normalizeToNumber:function(t,e=0){const i=Number(t);return a(i)?i:e},isEmpty:function(t){return!!(l(t)||u(t)||Number.isNaN(t))||(s(t)?""===t:a(t)||o(t)?0===t:n(t)?0===Object.keys(t).length:r(t)?0===t.length:!!i("Map",t)&&0===t.size)},urlQueryString:c,urlQueryParse:function(t){return c(`?${t}`).split("&").reduce((t,e)=>{const i=e.split("=");if(2===i.length){const[e,n]=i;t[e]=n}return t},{})}};function m(t,e,i,n){if("function"==typeof e?t!==e||!n:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===i?n:"a"===i?n.call(t):n?n.value:e.get(t)}function f(t,e,i,n,r){if("function"==typeof e?t!==e||!r:!e.has(t))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r?r.value=i:e.set(t,i),i}"function"==typeof SuppressedError&&SuppressedError;class v{static set prefix(t){f(this,d,t,"f",h)}static get defaultLogLevel(){return this.CRITICAL}static get logLevel(){return p.isNumber(m(this,d,"f",g))?m(this,d,"f",g):this.defaultLogLevel}static set logLevel(t){p.isNumber(t)&&[0,1,2,3,4].indexOf(t)>=0&&f(this,d,t,"f",g)}static debug(...t){this.logLevel<d.DEBUG||d.printLog(console.debug,t)}static info(...t){this.logLevel<d.INFO||d.printLog(console.info,t)}static warning(...t){this.logLevel<d.WARNING||d.printLog(console.warn,t)}static error(...t){this.logLevel<d.CRITICAL||d.printLog(console.error,t)}static printLog(t,e){const i=new Date,n=`[${i.toLocaleTimeString()}.${i.getUTCMilliseconds()}]`;t(...[p.isEmpty(m(this,d,"f",h))?"":`${m(this,d,"f",h)}`,n,...e].filter(Boolean))}}d=v,h={value:void 0},g={value:void 0},v.NONE=0,v.CRITICAL=1,v.WARNING=2,v.INFO=3,v.DEBUG=4;var y="YASCoreLogger-web",b="4.3.0";const w=["http","https","file"];var C,U;class A{static set apiHost(t){f(this,C,t,"f",U),"https://"===this.apiScheme&&(t=>{const e=document.createElement("link");e.setAttribute("rel","preconnect"),e.setAttribute("href",t),document.head.appendChild(e)})(`${this.apiScheme}${m(this,C,"f",U)}`)}static get apiHost(){return m(this,C,"f",U)}}C=A,A.apiScheme="https://",A.apiPath="/api/v1/stream",A.sendBeaconEnabled=!0,U={value:class{static getDefaultHost(){return new RegExp("yahoo.co.jp$").test(window.location.hostname)?"dsb.yahoo.co.jp":"dsb.yahooapis.jp"}}.getDefaultHost()},A.targetProtocols=["http","https"],A.ajaxTimeout=5e3,A.maxRequestCharCount=65497,A.maxRequestMessageCount=50,A.shortTimerInterval=1e3,A.longTimerInterval=5e3,A.errorLoggingEnabled=!1,A.sdkName=y,A.sdkVersion=b,A.apiAccessToken=null,v.debug("[config]",A);class E{static send(t,e=null){A.sendBeaconEnabled&&p.isNull(e)&&p.isFunction(window.navigator.sendBeacon)?this.sendBeacon(t):this.sendAjax(t,e)}static sendAjax(t,e){const i=new XMLHttpRequest,n=this.buildUrl();i.open("POST",n),i.withCredentials=!0,i.setRequestHeader("Content-Type","application/json;charset=UTF-8"),i.timeout=A.ajaxTimeout,i.onload=e,i.ontimeout=e,i.onerror=e,i.onabort=e,i.send(t),v.info("[送信]",n,t)}static sendBeacon(t){const e=this.buildUrl();navigator.sendBeacon(e,t),v.info("[送信]",e,t)}static buildUrl(){let t=`${A.apiScheme}${A.apiHost}${A.apiPath}`;const e=A.apiAccessToken;return null!==e&&(t+=`?access_token=${e}`),t}}class L{static recordBuild(t,e,i,n){if(!p.isString(t)||!p.isUUID(t))return v.error("tokenが不正な値:",t),null;if(!p.isString(e)||e.length<1)return v.error("projectが不正な値:",e),null;if(!p.isString(i)||i.length<1)return v.error("datasetが不正な値:",i),null;if(!p.isObject(n))return v.error("dataが不正な値:",n),null;const r=p.deepCopy(n);Object.keys(r).forEach(t=>{0===t.indexOf("cex_")&&(v.warning(`パラメータ ${t}: cex_で始まるキーは予約済みキーのため使用できません.`),delete r[t])}),r.cex_cqt=p.getTime();const s={tk:t,p:e,d:i,data:r};return v.info("[レコード生成]",s),s}static recordsBuild(t,e,i,n){const r=[],s=n=>{const s=this.recordBuild(t,e,i,n);p.isNull(s)||r.push(s)};return p.isArray(n)?n.forEach(s):s(n),r}static requestBodyBuild(t){const e=p.deepCopy(t),i={cex_cst:p.getTime()};return JSON.stringify({r:e,bp:i})}}class _{static get INACTIVE_EVENTS(){return["blur","pagehide","visibilitychange","beforeunload"]}constructor(t,e=null,i=null){this.buffer=t,this.shortInterval=i||A.shortTimerInterval,this.longInterval=e||A.longTimerInterval,this.shortTimer=null,this.longTimer=null,this.leaveCallback=t=>{"visibilitychange"===t.type&&"hidden"!==document.visibilityState||(v.debug(`fire inactive event. type = ${t.type}`),this.buffer.queue.length>0&&(this.buffer.send(),this.clearAllTimer()))},_.INACTIVE_EVENTS.forEach(t=>{window.addEventListener(t,this.leaveCallback,!1)}),this.onlineHandler=()=>{this.buffer.online=!0,this.buffer.queue.length>0&&this.buffer.send()},this.offlineHandler=()=>{this.buffer.online=!1},this.setInitialNetWork(),this.setNetWorkWatcher()}setInitialNetWork(){this.buffer.online=!p.isBoolean(window.navigator.onLine)||window.navigator.onLine}setNetWorkWatcher(){window.addEventListener("online",this.onlineHandler,!1),window.addEventListener("offline",this.offlineHandler,!1)}setTimer(){p.isNull(this.shortTimer)||(clearTimeout(this.shortTimer),this.shortTimer=null),this.shortTimer=setTimeout(()=>{this.buffer.send(),this.clearAllTimer(),v.debug("Called: short timer fire.")},this.shortInterval),p.isNull(this.longTimer)&&(this.longTimer=setTimeout(()=>{this.buffer.send(),this.clearAllTimer(),v.debug("Called: long timer fire.")},this.longInterval))}clearAllTimer(){p.isNull(this.shortTimer)||(clearTimeout(this.shortTimer),this.shortTimer=null),p.isNull(this.longTimer)||(clearTimeout(this.longTimer),this.longTimer=null)}}const T=new class{constructor(){this.online=!0,this.charCount=0,this.queue=[],this.charCountArray=[]}push(t,e,i,n){const r=L.recordsBuild(t,e,i,n),s=r.map(t=>JSON.stringify(t).length),o=s.reduce((t,e)=>t+e,0),a=r.length,l=Math.max(0,A.maxRequestCharCount),u=Math.max(0,A.maxRequestMessageCount);if(!(a<1))if(o>l)v.error(`データのサイズが大きすぎます。データを破棄します  ${o}/${l}`,r);else if(a>u&&v.warning(`規定値を超えた件数のログが送信されます ${a}/${u}`,r),this.charCount+o<=l&&this.queue.length+a<=u)this.queue=this.queue.concat(r),this.charCount+=o,this.charCountArray=this.charCountArray.concat(s);else if(this.online)this.send(),this.queue=this.queue.concat(r),this.charCount+=o,this.charCountArray=this.charCountArray.concat(s);else for(this.queue=this.queue.concat(r),this.charCount+=o,this.charCountArray=this.charCountArray.concat(s);this.charCount>l||this.queue.length>u;)v.warning("データ容量超過のため削除",this.queue[0]),this.queue.shift(),this.charCount-=this.charCountArray[0],this.charCountArray.shift()}send(t=null){if(this.queue.length>0&&this.online){const e=L.requestBodyBuild(this.queue);E.send(e,t),this.reset()}}reset(){this.queue=[],this.charCount=0,this.charCountArray=[]}},S=new _(T),M=(()=>{if(crypto.randomUUID)return crypto.randomUUID();const t=new Uint8Array(16);crypto.getRandomValues(t),t[6]=t[6]%16+64,t[8]=t[8]%64+128;const e=t=>t.toString(16).padStart(2,"0"),i=(i,n)=>Array.from(t.subarray(i,n)).map(e).join("");return[i(0,4),i(4,6),i(6,8),i(8,10),i(10,16)].join("-")})();v.prefix="[CoreLogger]",t.CLog=v,t.Util=p,t.default=class{static setConsoleLogLevel(t){v.logLevel=t}static getConsoleLogLevel(){return v.logLevel}static setBeaconServer(t,e){p.isString(t)?(A.apiHost=t,v.info("送信先ホスト変更成功",t)):p.isNull(t)||p.isUndefined(t)||v.warning("送信先ホスト変更失敗",t),p.isString(e)?(A.apiPath=e,v.info("送信先パス変更成功",e)):p.isNull(e)||p.isUndefined(e)||v.warning("送信先パス変更失敗",e)}static setAccessToken(t){p.isString(t)&&(A.apiAccessToken=t,v.info("[アクセストークン変更]",t))}static enableSecureTransport(t){!0===t?A.apiScheme="https://":!1===t&&(A.apiScheme="http://",v.warning("通信にHTTPを利用します"))}static enableSendBeacon(t){!0===t?(A.sendBeaconEnabled=!0,v.info("通信にsendBeaconまたはXHRを利用します")):!1===t?(A.sendBeaconEnabled=!1,v.info("通信にsendBeaconを利用せずXHRのみ利用します")):v.warning("boolean型の値を指定してください")}static setTargetProtocols(t){p.isArray(t)?t.some(t=>!(t=>w.includes(t))(t))?v.error("無効なプロトコルが含まれています。プロトコル設定を行いませんでした"):(A.targetProtocols=t,v.info("ロギング対象プロトコル変更",A.targetProtocols)):v.error("引数には配列を指定してください。プロトコル設定を行いませんでした")}static send(t){if(!p.isObject(t)||(e=t,!["token","project","dataset","data"].every(t=>t in e)))return void v.error("引数の型が不正");var e;const i=window.location.protocol.slice(0,-1);A.targetProtocols.includes(i)?(T.push(t.token,t.project,t.dataset,t.data),p.isUndefined(t.flush)||p.isBoolean(t.flush)||v.warning("flushオプションが期待するのはboolean型です"),!0===t.flush?this.flush(t.callback):S.setTimer()):v.error(`現在開いているページの ${i} プロトコルはロギング対象外です。`)}static flush(t=null){p.isFunction(t)?T.send(t):(p.isNull(t)||v.warning("callbackには関数を指定してください"),T.send())}static getSdkName(){return A.sdkName}static getSdkVersion(){return A.sdkVersion}static getPageSession(){return window.YAS=window.YAS||{},window.YAS.psid=window.YAS.psid||M,M}},Object.defineProperty(t,"__esModule",{value:!0})}(e)}(0,i.exports)),i.exports),r=t(n);const s={string:t=>n.Util.normalizeToString(t),number:t=>n.Util.normalizeToNumber(t,null),boolean:t=>Boolean(t),array:t=>n.Util.isArray(t)?t:null};const o=t=>Object.keys(t),a=(t,e)=>{const i=e[0],r=e[1],o=e[2],a=((t,e)=>n.Util.isUndefined(e)||n.Util.isNull(e)?null:s[t](e))(o,r);return n.Util.isNull(a)?(n.CLog.warning(`[Validator#run] ${i}に${o}型に変換出来ない値(${r})が指定されています`),t):(t[i]=a,t)};var l={ruleSets:{},aliasMap:{},addRuleSet(t,e){if(!n.Util.isString(t)||n.Util.isEmpty(t))return void n.CLog.error("[Validator#addRule] 不正なアクションID",t);if(!n.Util.isObject(e))return void n.CLog.error("[Validator#addRule] 不正なRuleSet",e);const i=o(e).reduce((t,i)=>{const r=e[i];var s;return s=r.alias,n.Util.isString(s)&&(this.aliasMap[r.alias]=i),t[i]={type:r.type},t},{});this.ruleSets[t]=i},run(t,e){if(!n.Util.isString(t)||n.Util.isEmpty(t))return n.CLog.error("[Validator#run] アクションIDが不正",t),null;if(n.Util.isUndefined(this.ruleSets[t]))return n.CLog.error(`[Validator#run] アクション ${t} に紐付くルールセットが未登録`,this.ruleSets),null;if(!n.Util.isObject(e))return n.CLog.error("[Validator#run] データの形式が不正",e),null;const i=this.ruleSets[t],r=o(i),s=[];return o(e).forEach(t=>{const n=this.aliasMap[t]||t;-1!==r.indexOf(n)&&s.push([n,e[t],i[n].type])}),s.reduce(a,{})}};const u={viewStart:{list:"view_content_list_start",detail:"view_content_detail_start",digest:"view_content_digest_start"},viewEnd:{list:"view_content_list_end",detail:"view_content_detail_end",digest:"view_content_digest_end"},flow:"go_to_content",view_video_start:"view_video_start",view_video_end:"view_video_end",pageview:"pageview",cv:"cv",search:"search"},c={ts:{type:"number"},action_id:{type:"string"},content_id:{type:"string",alias:"contid"},id_type:{type:"string",alias:"idtype"},page_session:{type:"string"},url:{type:"string"},service:{type:"string"},apptype:{type:"string"},opttype:{type:"string"},os:{type:"string"},sdk:{type:"string"},sdk_ver:{type:"string"},extension:{type:"string"},extension_ver:{type:"string"},mtestid:{type:"string"},ss_join_id:{type:"string"},ss_join_id_type:{type:"string"},referer:{type:"string"}},d={element_id:{type:"string"}};var h=n.Util.merge({},d);var g=n.Util.merge({start_time:{type:"number"},end_time:{type:"number"},view_time:{type:"number"},view_rate:{type:"number"}},d);const p={current_page:{type:"number"}};var m=n.Util.merge({total_page:{type:"number"}},p);const f={list:n.Util.merge(g,{viewable_time:{type:"number"}}),detail:n.Util.merge(g,m),digest:n.Util.merge(g,{})};var v=n.Util.merge({video_id:{type:"string"},autoplay:{type:"boolean"},start_time_position:{type:"number"}},d);var y=n.Util.merge(v,{});var b=n.Util.merge(v,{end_time_position:{type:"number"}});var w=n.Util.merge({href:{type:"string"}},d);var C=n.Util.merge({origin_query:{type:"string"},result_query:{type:"string"},entities:{type:"array"},search_type:{type:"string"},page_type:{type:"string"},hierarchy_id:{type:"string"}},p);const U=u.viewStart,A=u.viewEnd,E={};E[U.list]=n.Util.merge(c,h),E[U.detail]=n.Util.merge(c,h),E[U.digest]=n.Util.merge(c,h),E[A.list]=n.Util.merge(c,f.list),E[A.detail]=n.Util.merge(c,f.detail),E[A.digest]=n.Util.merge(c,f.digest),E[u.view_video_start]=n.Util.merge(c,y),E[u.view_video_end]=n.Util.merge(c,b),E[u.flow]=n.Util.merge(c,w),E[u.pageview]=n.Util.merge(c,{nopv:{type:"boolean"},hierarchy_id:{type:"string"}}),E[u.cv]=n.Util.merge(c,{cv_id:{type:"string"}}),E[u.search]=n.Util.merge(c,C);var L=new class{constructor(){this.config={project:null,actionList:[],extensionName:null,extensionVersion:null,token:void 0}}setToken(t){void 0===this.config.token&&(this.config.token=t)}getToken(){return void 0!==this.config.token?this.config.token:null}setProject(t){this.config.project=t}getProject(){return this.config.project}setExtensionName(t){this.config.extensionName=t}getExtensionName(){return this.config.extensionName}setExtensionVersion(t){this.config.extensionVersion=t}getExtensionVersion(){return this.config.extensionVersion}setActionList(t){this.config.actionList=t}isValidAction(t){return-1!==this.config.actionList.indexOf(t)}hasContentAction(){const t=Object.values(u.viewStart),e=Object.values(u.viewEnd);return!![u.flow].concat(t).concat(e).some(t=>this.isValidAction(t))}};const _=["pageview","cv","search","view_video_start","view_video_end"],T={},S=new class{constructor(){this.parameters={}}addParameter(t,e){this.parameters[t]=e}getParameters(){return this.parameters}};class M{static viewStart(t){this.dispatch("viewStart",t)}static viewEnd(t,e=!1){this.dispatch("viewEnd",t,e)}static flow(t,e){t.setFlowInfo(e),this.dispatch("flow",t),t.unsetFlowInfo()}static hit(t,e,i=!1){this.dispatch(t,e,i)}static dispatch(t,e,i=!1){var s,o;const a=((t,e)=>{const i=u[t];if(n.Util.isString(i))return i;const r=null==e?void 0:e.viewType;return n.Util.isString(r)&&"internal"!==r?i[r]:null})(t,e);if(null===a)return void n.CLog.error("[LogDispatcher#dispatch] 該当するアクションIDが存在しません",a,e);if(!L.isValidAction(a))return void n.CLog.error("[LogDispatcher#hit] 対象のアクションはロギング対象ではありません",a);if(n.Util.isUndefined(T[a]))return void n.CLog.error("[LogDispatcher#dispatch] アクションIDに対し適切なビルダーが設定されていません",a);const l=T[a].run(a,S,e);null!==l&&r.send({token:null!==(s=L.getToken())&&void 0!==s?s:"",project:null!==(o=L.getProject())&&void 0!==o?o:"",dataset:a,data:l,flush:i})}static addBuilder(t,e){return n.Util.isEmpty(t)?(n.CLog.error("[LogDispatcher#addBuilder] アクションIDには空でない文字列を指定してください",`actionId = ${t}`),!1):(T[t]=e,!0)}static addGlobalData(t){Object.entries(t).forEach(([t,e])=>{S.addParameter(t,e)})}static getToken(){return L.getToken()}static setBroker(t,e){r.setBeaconServer(t,e)}static setAccessToken(t){r.setAccessToken(t)}static removeBuilder(t){delete T[t]}}const j=r.getPageSession(),D=()=>document.URL,x="data-ual",N="data-ual-view-type",k="data-ual-gotocontent",O="data-ual-gotodigest-noflow",H="data-ual-gotocontent-noflow",P="data-ual-content-key",I="data-ual-new-data",B="data-ual-update-data",$={list:"list",digest:"digest",detail:"detail",internal:"internal"},q=t=>{const[e,...i]=t.split(":");return e?[e.trim(),i.join(":").trim()]:[]},F=(t,e)=>{if(2===e.length){const[i,n]=e;t[i]=n}return t};var V=t=>t instanceof HTMLElement,R=t=>t instanceof HTMLAnchorElement&&t.hasAttribute(k),W=t=>t instanceof Navigator,z=(t,e=null)=>{const i=e||x;return((null==t?void 0:t.getAttribute(i))||"").split(";").map(q).reduce(F,{})},G=(t,e={})=>{const i=Object.entries(e).map(([t,e])=>`${t}:${e}`).join(";");t.setAttribute(x,i)},J=t=>{const e=t.getAttribute(N);return Object.values($).find(t=>t===e)?e:null};const Y=()=>{if(!W(navigator))return n.CLog.error("[osName()] navigatorオブジェクトが存在しません"),null;const t=navigator.userAgent;let e="other";return t.match(/windows\sphone/i)?e="windowsphone":t.match(/windows/i)?e="windows":t.match(/iphone|ipad/i)?e="ios":t.match(/mac|ppc/i)?e="mac":t.match(/android/i)&&(e="android"),e},X=r.getSdkName(),K=r.getSdkVersion();class Q{static buildCommonParameters(){return{content_id:null,id_type:null,service:null,apptype:"web",opttype:null,mtestid:null,ss_join_id:null,ss_join_id_type:null,referer:document.referrer}}static buildActionParameters(t){return{}}static buildGlobalParameters(t){return null===t?{}:t.getParameters()}static buildContentParameters(t){return null===t?{}:t.getParameters()}static buildFixedParameters(t,e){return{ts:n.Util.getTime(),action_id:t,page_session:j,url:D(),os:Y(),sdk:X,sdk_ver:K,extension:L.getExtensionName(),extension_ver:L.getExtensionVersion()}}static run(t,e=null,i=null){if(!n.Util.isObject(this.validator)||!n.Util.isFunction(this.validator.run))return n.CLog.error("[BaseBuilder.run] バリデータが未登録か不正です.",this.validator),null;const r=this.buildCommonParameters(),s=this.buildActionParameters(i),o=this.buildGlobalParameters(e),a=this.buildContentParameters(i),l=this.buildFixedParameters(t,i);n.CLog.debug("[BaseBuilder#run] Parameters:","common = ",r,"action = ",s,"global = ",o,"content = ",a,"fixed = ",l);const u=this.validator.run(t,r)||{},c=this.validator.run(t,s)||{},d=this.validator.run(t,o)||{},h=this.validator.run(t,a)||{},g=this.validator.run(t,l)||{};return n.Util.merge(u,c,d,h,g)}}class Z extends Q{static buildActionParameters(t){const e=t.viewType;return{start_time:t.viewStartTime,end_time:t.viewEndTime,view_time:t.viewEndTime-t.viewStartTime,viewable_time:e===$.list?t.viewableTime:null,view_rate:t.readProportion,current_page:null,total_page:null}}}const tt=()=>{var t,e;const i=D(),n=new URL(i).searchParams,r=null!==(e=null!==(t=n.get("p"))&&void 0!==t?t:n.get("q"))&&void 0!==e?e:n.get("query");return null!==r?(t=>decodeURIComponent(t.replace(/\+/g,"%20")))(r):null};const et=u.viewStart,it=u.viewEnd,nt={};nt[et.list]=Q,nt[et.detail]=Q,nt[et.digest]=Q,nt[it.list]=Z,nt[it.detail]=Z,nt[it.digest]=Z,nt[u.view_video_start]=Q,nt[u.view_video_end]=Q,nt[u.flow]=class extends Q{static buildActionParameters(t){return{href:t.url}}},nt[u.pageview]=class extends Q{static buildActionParameters(t){return{nopv:!1}}},nt[u.cv]=Q,nt[u.search]=class extends Q{static buildActionParameters(t){return{origin_query:tt()}}};class rt{constructor(t=100){this.isActive=!1,this.interval=t}runTimer(){this.isActive&&(this.monitor(),setTimeout(()=>{this.runTimer()},this.interval))}start(){this.isActive||(this.isActive=!0,this.runTimer())}stop(){this.isActive=!1}}const st=()=>({w:window.innerWidth,h:window.innerHeight}),ot=t=>{const e=t.getBoundingClientRect();return{x:e.left,y:e.top,r:e.right,b:e.bottom,w:e.width,h:e.bottom-e.top}},at=(t,e)=>{const i=n.Util.isObject(e)?e:{},r=i.top||0,s=i.bottom||0;return{x:0,y:r,r:t.w,b:t.h-s,w:t.w,h:t.h-r-s}},lt=(t,e,i,n)=>{const r=getComputedStyle(t);if("hidden"===r.getPropertyValue("visibility")||"none"===r.getPropertyValue("display"))return!0;const s=at(e,n);return i.x>=s.r||i.r<=s.x||i.y>=s.b||i.b<=s.y},ut=(t,e,i)=>{const n=at(t,i),r=Math.max(n.x,e.x),s=Math.min(e.r,n.r),o=Math.max(n.y,e.y),a=Math.min(n.b,e.b);return{x:r,y:o,r:s,b:a,w:s-r,h:a-o}};var ct=(t,e={})=>{const i=st(),n=ot(t);if(lt(t,i,n,e))return 0;const r=n.w*n.h,s=ut(i,n,e);return s.w*s.h/r*100},dt=(t,e={})=>{if(!V(t))return n.CLog.error("[visibility.getReadRange] 不正な引数",t),null;const i=st(),r=ot(t);if(lt(t,i,r,e))return null;const s=r.y,o=r.h,a=s+o,l=ut(i,r,e),u=(l.y-s)/o*100,c=(o-(a-l.b))/o*100;if(c-u<1)return null;return{start:Math.ceil(u),end:Math.floor(c)-1}};const ht="ual.modulechange",gt={none:0,start:1,end:2},pt=gt;class mt{constructor(t,e=null){this.cp=z(t),this.mp=null!==e?z(e):{},this.lp={},this.hp={},this.vt=J(t),null===this.vt&&n.CLog.error("[ContentDataModel.constructor] 規定外の表示種別",t),this.vap=0,this.vst=0,this.vet=0,this.vast=null,this.vat=this.vt===$.list?0:null,this.rpf=[];for(let t=0;t<100;t+=1)this.rpf[t]=!1;this.href=null}getParameters(){return n.Util.merge({},this.mp,this.cp,this.lp,this.hp)}setHitParameters(t){this.hp=n.Util.isObject(t)?t:{}}setFlowInfo(t){const e=[k,O,H].find(e=>t.hasAttribute(e))||null;this.lp=z(t,e),R(t)?this.href=t.href:e!==H&&e!==O||(this.href=document.URL)}unsetFlowInfo(){this.lp={},this.href=null}get viewType(){return this.vt}get viewStartTime(){return this.vst}get viewEndTime(){return this.vet}get viewableTime(){return this.vat}get readProportion(){return this.rpf.filter(t=>t).length}get url(){const{href:t}=this;return n.Util.isString(t)&&!n.Util.isEmpty(t)?t:null}update(t){let e=pt.none;return 0===this.vap&&0!==t?(this.vst=n.Util.getTime(),e=pt.start):0!==this.vap&&0===t&&(this.vet=n.Util.getTime(),e=pt.end),this.vt===$.list&&(null===this.vast&&t>=50?this.vast=n.Util.getTime():null!==this.vast&&t<50&&(null!==this.vat&&(this.vat+=n.Util.getTime()-this.vast),this.vast=null)),this.vap=t,e}read(t,e){for(let i=t;i<=e;i+=1)this.rpf[i]=!0}}class ft{constructor(){this.top=0,this.bottom=0}getOffset(){return{top:this.top,bottom:this.bottom}}setOffset(t){this.top=t.top,this.bottom=t.bottom}}let vt=!1;var yt=(t,e)=>{if(!vt)return void(t=>{const e=t.querySelector(".uainfo");null!==e&&t.removeChild(e);const i=t.getAttribute("data-ual-debug-style");if(null!==i){const e=JSON.parse(i);Object.assign(t.style,e),t.removeAttribute("data-ual-debug-style")}})(t);const i=(t=>{const e=t.querySelector(".uainfo");if(null!==e)return e;const i=document.createElement("div");return i.className="uainfo",i.style.position="absolute",i.style.backgroundColor="rgba(0,0,0,0.4)",i.style.color="#FFF",i.style.padding="3px",i.style.left="0",i.style.fontSize="13pt",i.style.zIndex="100000",t.appendChild(i),i})(t);i.innerHTML=(t=>{let e="";const i=t.getParameters();let n=null;"number"!=typeof i.content_id&&"boolean"!=typeof i.content_id&&"string"!=typeof i.content_id||(n=i.content_id.toString()),"number"!=typeof i.contid&&"boolean"!=typeof i.contid&&"string"!=typeof i.contid||(n=n||i.contid.toString()),null!==n&&(e+=`${n.substring(0,12)}<br>`);const{vap:r}=t,s=t.readProportion;e+=`${`${r}`.substring(0,5)}%<br>ViewRate:${s}%<br>`;const o=t.viewStartTime;return e+=`ViewTime:${o>0?Math.floor(((new Date).getTime()-o)/1e3):0}秒`,e})(e),((t,e)=>{if(!t.hasAttribute("data-ual-debug-style")){const e={borderColor:t.style.borderColor,borderWidth:t.style.borderWidth,borderStyle:t.style.borderStyle};t.setAttribute("data-ual-debug-style",JSON.stringify(e))}const{vap:i}=e,n={borderColor:i>0?"red":"rgba(0,0,0,0)",borderWidth:"1px",borderStyle:"solid"};Object.assign(t.style,n)})(t,e)},bt=()=>{vt=!0},wt=()=>{vt=!1};const Ct=P,Ut=gt,At=(t,e,i,n,r,s=!1,o=!1)=>{let a=null,l=0;const u=r instanceof ft?r.getOffset():{};V(e)&&(a=dt(e,u),l=ct(e,u)),null!==a&&t.read(a.start,a.end);let c=t.update(l);if(c!==Ut.end&&o&&(c=t.update(0)),c===Ut.start)null!==i&&i(t);else if(c===Ut.end)return null!==n&&n(t,s),null;return null!==e&&yt(e,t),t};class Et extends rt{constructor(t,{startHandler:e,endHandler:i,moduleChangeHandler:n,moduleDestroyHandler:r,offsetData:s}){super(),this.contentDataMap={},this.startHandler=e,this.endHandler=i,this.moduleChangeHandler=n,this.moduleDestroyHandler=r,this.offsetData=s,this.module=t,t.addEventListener(ht,this.moduleChangeHandler)}monitor(){const t=this.module.querySelectorAll(`[${x}]`),e=Array.prototype.slice.call(t),i=e.filter(t=>t.hasAttribute(Ct)).reduce((t,e)=>n.Util.merge(t,this.reuseContentData(e)),{}),r=e.filter(t=>!t.hasAttribute(Ct)),s=r.reduce((t,e)=>n.Util.merge(t,this.createContentData(e)),{});return n.Util.isEmpty(r)||this.module.dispatchEvent(new Event(ht)),this.finalize(),this.contentDataMap=n.Util.merge(i,s),!0}flush(){const t=this.module.querySelectorAll(`[${x}]`);return Array.prototype.slice.call(t).forEach(t=>{this.flushContentData(t),t.removeAttribute(Ct)}),this.contentDataMap={},!0}createContentData(t){const e={},i=new mt(t,this.module);if(null===i.viewType)return e;const n=(()=>{if(crypto.randomUUID)return crypto.randomUUID();const t=new Uint8Array(16);crypto.getRandomValues(t),t[6]=t[6]%16+64,t[8]=t[8]%64+128;const e=t=>t.toString(16).padStart(2,"0"),i=(i,n)=>Array.from(t.subarray(i,n)).map(e).join("");return[i(0,4),i(4,6),i(6,8),i(8,10),i(10,16)].join("-")})();return t.setAttribute(Ct,n),e[n]=At(i,t,this.startHandler,this.endHandler,this.offsetData),e}reuseContentData(t){const e=t.getAttribute(Ct);if(null===e||n.Util.isUndefined(this.contentDataMap[e]))return{};const i=this.contentDataMap[e];delete this.contentDataMap[e];const r={};return r[e]=At(i,t,this.startHandler,this.endHandler,this.offsetData),null===r[e]?(t.removeAttribute(Ct),{}):r}flushContentData(t,e=!1){const i=t.getAttribute(Ct);null===i||n.Util.isUndefined(this.contentDataMap[i])||(At(this.contentDataMap[i],t,this.startHandler,this.endHandler,this.offsetData,e,!0),delete this.contentDataMap[i])}replaceContentData(t,e){this.flushContentData(t),Et.updateContentElement(t,e),this.contentDataMap=n.Util.merge(this.contentDataMap,this.createContentData(t))}static updateContentElement(t,e){e.hasAttribute(O)?t.setAttribute(N,$.digest):e.hasAttribute(H)&&t.setAttribute(N,$.detail);const i=e.getAttribute(I);if(null!==i)t.setAttribute(x,i);else if(null!==e.getAttribute(B)){const i=z(t,x),r=z(e,B);G(t,n.Util.merge(i,r))}}finalize(t=!1){const{contentDataMap:e}=this;Object.values(e).forEach(e=>{At(e,null,null,this.endHandler,this.offsetData,t)})}destroy(){var t;null!==this.moduleChangeHandler&&this.module.removeEventListener(ht,this.moduleChangeHandler),null===(t=this.moduleDestroyHandler)||void 0===t||t.call(this,this.module)}}const Lt={isHidden:!1},_t=[],Tt=[],St=["focus","pageshow"],Mt=["blur","pagehide","beforeunload"],jt=()=>{Lt.isHidden&&(_t.forEach(t=>t()),Lt.isHidden=!1)},Dt=()=>{Lt.isHidden||(Tt.forEach(t=>t()),Lt.isHidden=!0)},xt=()=>{document.hidden?Dt():jt()};var Nt=t=>{n.Util.isFunction(t)&&_t.push(t)},kt=t=>{n.Util.isFunction(t)&&Tt.push(t)},Ot=()=>{St.forEach(t=>{window.removeEventListener(t,jt),window.addEventListener(t,jt,!1)}),Mt.forEach(t=>{window.removeEventListener(t,Dt),window.addEventListener(t,Dt,!1)});const t="visibilitychange";document.removeEventListener(t,xt),document.addEventListener(t,xt,!1)},Ht=()=>{_t.splice(0,_t.length),Tt.splice(0,Tt.length)};const Pt=[],It=[],Bt=["yjsmhSidebarClose","yjsmhNotificationMenuClose"],$t=["yjsmhSidebarOpen","yjsmhNotificationMenuOpen"],qt=()=>{Lt.isHidden&&(Pt.forEach(t=>t()),Lt.isHidden=!1)},Ft=()=>{Lt.isHidden||(It.forEach(t=>t()),Lt.isHidden=!0)};var Vt=t=>{n.Util.isFunction(t)&&Pt.push(t)},Rt=t=>{n.Util.isFunction(t)&&It.push(t)},Wt=t=>{var e;(e=t,n.Util.is("HTMLDivElement",e))&&(Bt.forEach(e=>{t.removeEventListener(e,qt),t.addEventListener(e,qt,!1)}),$t.forEach(e=>{t.removeEventListener(e,Ft),t.addEventListener(e,Ft,!1)}))},zt=()=>{Pt.splice(0,Pt.length),It.splice(0,It.length)};const Gt=[],Jt=t=>{let e=t.target;for(;e&&!e.hasAttribute(k)&&!e.hasAttribute(O)&&!e.hasAttribute(H);)e=e.parentNode;Gt.forEach(t=>t(e))},Yt=t=>{const e=`a[${k}], [${O}], [${H}]`,i=t.querySelectorAll(e);return Array.prototype.slice.call(i)},Xt=t=>{V(t)&&Yt(t).forEach(t=>{t.removeEventListener("click",Jt,!0),t.addEventListener("click",Jt,!0)})},Kt=t=>{V(t)&&Yt(t).forEach(t=>{t.removeEventListener("click",Jt,!0)})};var Qt=t=>{n.Util.isFunction(t)&&Gt.push(t)},Zt=t=>{let e;e=Array.isArray(t)?t:[t],e.forEach(Xt)},te=t=>{let e;e=Array.isArray(t)?t:[t],e.forEach(Kt)},ee=()=>{Gt.splice(0,Gt.length)};const ie=()=>{const t=(()=>{const t=document.body.getElementsByTagName("*"),e=[];return Array.from(t).forEach(t=>{const i=getComputedStyle(t);"fixed"===i.position&&"none"!==i.display&&"hidden"!==i.visibility&&e.push(t)}),e})(),e=window.innerWidth/2,i=window.innerHeight,n=i/2,r=t.map(t=>t.getBoundingClientRect()).filter(t=>t.width>e&&t.height>0);return{top:r.filter(t=>t.bottom<n).map(t=>t.bottom).reduce((t,e)=>Math.max(t,e),0),bottom:r.filter(t=>t.top>n).map(t=>t.top).reduce((t,e)=>Math.max(t,i-e),0)}};class ne{static addModule(t){const{monitorMap:e}=ne;return n.Util.isUndefined(e[t.id])?(e[t.id]=new Et(t,{startHandler:ne.handleViewStart,endHandler:ne.handleViewEnd,moduleChangeHandler:ne.moduleChangeHandler,moduleDestroyHandler:ne.moduleDestroyHandler,offsetData:ne.offsetMonitor.offsetData}),!0):(n.CLog.error("[Dispatcher#addModule] 登録済みのモジュールです.",t.id),!1)}static removeModule(t){const{monitorMap:e}=ne;return n.Util.isUndefined(e[t])?(n.CLog.error("[Dispatcher#removeModule] 登録されていないモジュールです",t),!1):(ne.stopMonitor(e[t]),e[t].destroy(),delete e[t],!0)}static startMonitors(){null!==M.getToken()?Object.values(ne.monitorMap).forEach(t=>{t.start()}):n.CLog.error("[LogDispatcher#startMonitors] token が未設定です")}static stopMonitor(t){t.stop(),t.flush()}static stopMonitors(){Object.values(ne.monitorMap).forEach(t=>{ne.stopMonitor(t)}),r.flush()}static handleViewStart(t){M.viewStart(t)}static handleViewEnd(t,e=!1){M.viewEnd(t,e)}static handleFlow(t){ne.startMonitors(),t.hasAttribute(O)||t.hasAttribute(H)?ne.actionNoflow(t):R(t)&&ne.actionFlow(t)}static actionFlow(t){const e=ne.findContentData(t);null!==e?(M.flow(e,t),ne.stopMonitors()):n.CLog.error("[Dispatcher#actionFlow] 対応するコンテンツデータが見つかりません",t)}static actionNoflow(t){const e=ne.findContentData(t);if(null===e)return void n.CLog.error("[Dispatcher#actionNoflow] 対応するコンテンツデータが見つかりません",t);M.flow(e,t);const i=ne.findContentElement(t);if(null===i)return;const r=i.getAttribute(P),s=ne.findContentMonitor(r);null!==s&&s.replaceContentData(i,t)}static findContentElement(t){let e=t;for(;V(e);){if(e.hasAttribute(P))return e;e=e.parentNode}return null}static findContentData(t){const e=ne.findContentElement(t);if(n.Util.isEmpty(e)||null===e)return null;const i=e.getAttribute(P),r=ne.findContentMonitor(i);return n.Util.isEmpty(r)||null===r?null:r.contentDataMap[i]}static initMonitors(){const{monitorMap:t}=ne;Object.keys(t).forEach(e=>{delete t[e]}),Ht(),Nt(ne.startMonitors),kt(ne.stopMonitors),Ot(),zt(),Vt(ne.startMonitors),Rt(ne.stopMonitors),Wt(document.getElementById("wrapper")),ee(),Qt(ne.handleFlow)}static resetMonitors(){const{monitorMap:t}=ne;Object.keys(t).forEach(e=>{delete t[e]}),Ht(),zt(),ee()}}ne.findContentMonitor=t=>Object.values(ne.monitorMap).reduce((e,i)=>e||(i.contentDataMap[t]?i:null),null),ne.moduleChangeHandler=t=>{Zt(t.currentTarget)},ne.moduleDestroyHandler=t=>{te(t)},ne.offsetMonitor=new class extends rt{constructor(t=1e3){super(t),this.offsetData=new ft}monitor(){const t=ie();return this.offsetData.setOffset(t),!0}},ne.monitorMap={};const re=["start","stop"];const se=["token","host","path","accessToken","project","action","extension"];const oe=["start","stop"];class ae{static buildContentData(t){if(!n.Util.isObject(t)||null==t)return null;const e=document.createElement("li");e.setAttribute("data-ual-view-type",$.internal);const i=new mt(e);return i.setHitParameters(t),i}static run(t,e,i=!1){const n=this.buildContentData(e);M.hit(t,n,i)}}var le={init:class{static addModule(t){return!1!==ne.addModule(t)||(n.CLog.error("[InitCommander.run] モジュールの登録に失敗しました"),!1)}static run(t){const e=(n.Util.isArray(t)?t:[t]).map(t=>document.getElementById(t));return e.length&&e.every(t=>V(t))?e.reduce((t,e)=>this.addModule(e)&&t,!0):(n.CLog.error("[InitCommander.run] 予期しないモジュールの指定",t),!1)}},deinit:class{static removeModule(t){return!1!==ne.removeModule(t)||(n.CLog.error("[DeinitCommander.run] モジュールの削除に失敗しました"),!1)}static validateModuleId(t){return!(!n.Util.isString(t)||n.Util.isEmpty(t))||(n.CLog.error("予期しないモジュールの指定",t),!1)}static run(t){const e=n.Util.isArray(t)?t:[t];if(!e.length||!e.every(t=>this.validateModuleId(t)))return n.CLog.error("[DeinitCommander.run] 予期しないモジュールの指定",t),!1;const i=e.reduce((t,e)=>this.removeModule(e)&&t,!0);return i&&r.flush(),i}},offset:class{static run(t){if(!n.Util.isObject(t))return n.CLog.error("[OffsetCommander#run] 予期しないoptionsの型指定",t),!1;const e={auto:!!n.Util.isBoolean(t.auto)&&t.auto,interval:n.Util.isNumber(t.interval)&&t.interval>0?t.interval:1e3,top:n.Util.isNumber(t.top)?t.top:0,bottom:n.Util.isNumber(t.bottom)?t.bottom:0},i=ne.offsetMonitor;return e.auto?(i.interval=e.interval,i.start()):(i.stop(),i.offsetData.setOffset({top:e.top,bottom:e.bottom})),!0}},ctrl:class{static run(t){return!n.Util.isString(t)||n.Util.isEmpty(t)?(n.CLog.error("[CtrlCommander.run] サブコマンドの型または値が不正",t,"type: "+typeof t),!1):(t=>"string"==typeof t&&re.includes(t))(t)?(this[t](),!0):(n.CLog.error("[CtrlCommander.run] 未定義のサブコマンド",t),!1)}static start(){ne.startMonitors()}static stop(){ne.stopMonitors()}},global:class{static run(t){return n.Util.isObject(t)?(M.addGlobalData(t),!0):(n.CLog.error("[GlobalCommander#run] 予期しないパラメータの型指定",t),!1)}},config:class{static run(t,e={}){return!n.Util.isString(t)||n.Util.isEmpty(t)?(n.CLog.error("[ConfigCommander#run] サブコマンドの型または値が不正",t,"type: "+typeof t),!1):(t=>"string"==typeof t&&se.includes(t))(t)?(("token"===t||"host"===t||"path"===t||"accessToken"===t||"project"===t||"action"===t||"extension"===t)&&this[t](e),!0):(n.CLog.error("[ConfigCommander#run] 未定義のサブコマンド",t),!1)}static token(t){L.setToken(t)}static host(t){M.setBroker(t,null)}static path(t){M.setBroker(null,t)}static accessToken(t){M.setAccessToken(t)}static project(t){L.setProject(t)}static action(t){n.Util.isArray(t)?(L.setActionList(t),L.hasContentAction()?ne.initMonitors():ne.resetMonitors()):n.CLog.error("[ConfigCommander.action] 引数の型が不正",t)}static extension(t){const e="[ConfigCommander.extension] ";n.Util.isObject(t)?n.Util.isString(t.name)&&!n.Util.isEmpty(t.name)?n.Util.isString(t.version)&&!n.Util.isEmpty(t.version)?(L.setExtensionName(t.name),L.setExtensionVersion(t.version)):n.CLog.error(`${e}versionが不正な型か空の文字列`,t):n.CLog.error(`${e}nameが不正な型か空の文字列`,t):n.CLog.error(`${e}引数が不正な型`,t)}},debug:class{static run(t){return!n.Util.isString(t)||n.Util.isEmpty(t)?(n.CLog.error("[DebugCommander.run] サブコマンドの型または値が不正",t,"type: "+typeof t),!1):(t=>"string"==typeof t&&oe.includes(t))(t)?(this[t](),!0):(n.CLog.error("[DebugCommander.run] 未定義のサブコマンド",t),!1)}static start(){bt()}static stop(){wt()}},hit:class{static run(t,e,i={flush:!1}){if("string"!=typeof(r=t)||!_.includes(r))return n.CLog.error("[HitCommander.run] アクションIDの型または値が不正",t,"type: "+typeof t),!1;var r;if(!n.Util.isUndefined(e)&&!n.Util.isNull(e)&&!n.Util.isObject(e))return n.CLog.error("[HitCommander.run] ログパラメータの型または値が不正",e,`type: ${n.Util.getType(e)}`),!1;const s=Object.assign(Object.assign({},i),{flush:!!n.Util.isBoolean(i.flush)&&i.flush});return ae.run(t,e,s.flush),!0}},use:class{static run(t,e=null){return!n.Util.isString(t)||n.Util.isEmpty(t)?(n.CLog.error("[UseCommander#run] サブコマンドの型または値が不正",t,"type: "+typeof t),!1):"core"!==t?(n.CLog.error("[UseCommander#run] 未定義のサブコマンド",t),!1):null!==e&&n.Util.isFunction(e)?(this[t](e),!0):(n.CLog.error("[UseCommander#run] コールバック関数の型が不正",e,"type: "+typeof e),!1)}static core(t){t(r)}}},ue=(t,...e)=>{if(n.Util.isUndefined(t))n.CLog.warning("[ual] コマンドが指定されていません");else if("string"==typeof t&&n.Util.findKey(le,t)&&n.Util.isFunction(le[t].run))try{le[t].run.apply(le[t],e)}catch(t){n.CLog.warning("[ual] 予期しないエラーが発生しました",t)}else n.CLog.warning("[ual] 指定されたコマンドが見つかりません",t)};Object.keys(E).forEach(t=>{l.addRuleSet(t,E[t])}),Object.keys(nt).forEach(t=>{nt[t].validator=l,M.addBuilder(t,nt[t])}),n.CLog.prefix="[UAL]";var ce={name:"YASUserActionLogger-web",version:"4.2.0"};function de(t,e){return((t,e)=>{var i;Object.keys(e).forEach(t=>{const i=e[t];ue("config",t,i)});const r=`${t}ualdebug`,s=`${t}ualcmds`,o=document.URL.match(new RegExp(`${r}=(\\d)`));if(null!==o){const t=n.Util.normalizeToNumber(o[1]);n.CLog.logLevel=t}return n.Util.isArray(window[s])&&(null===(i=window[s])||void 0===i||i.forEach(t=>{n.CLog.debug("ual() was called from command queue.",t),ue(...t)})),ue})(t,Object.assign(Object.assign({},e),{extension:ce}))}return de("tm",{project:"yas_useractionpool",action:["view_video_start","view_video_end","pageview","cv","search"]})});